name: PR Sync Check

on:
  pull_request:
    branches: [staging, main]
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  statuses: write

jobs:
  sync-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Shopify CLI
        run: npm install -g @shopify/cli @shopify/theme

      - name: Configure Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"

      - name: Merge Latest Base Branch
        id: merge-base
        run: |
          echo "Fetching latest ${{ github.base_ref }} branch..."
          git fetch origin ${{ github.base_ref }}

          echo "Attempting to merge origin/${{ github.base_ref }} into current branch..."
          if git merge origin/${{ github.base_ref }} --no-edit; then
            echo "Successfully merged ${{ github.base_ref }} into PR branch"
            echo "merge_success=true" >> $GITHUB_OUTPUT
          else
            echo "Merge conflicts detected with ${{ github.base_ref }} branch"
            echo "merge_success=false" >> $GITHUB_OUTPUT
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Determine Target Environment
        if: steps.merge-base.outputs.merge_success == 'true'
        id: target
        run: |
          if [ "${{ github.base_ref }}" == "main" ]; then
            echo "Syncing from staging to check production compatibility"
            echo "store_url=${{ secrets.SHOPIFY_FLAG_STORE }}" >> $GITHUB_OUTPUT
            echo "theme_token=${{ secrets.SHOPIFY_CLI_THEME_TOKEN }}" >> $GITHUB_OUTPUT
          else
            echo "Syncing from production to staging"
            echo "store_url=${{ secrets.PRODUCTION_STORE }}" >> $GITHUB_OUTPUT
            echo "theme_token=${{ secrets.PRODUCTION_THEME_ACCESS_PASSWORD }}" >> $GITHUB_OUTPUT
          fi

      - name: Pull Latest Theme
        if: steps.merge-base.outputs.merge_success == 'true'
        env:
          SHOPIFY_FLAG_STORE: ${{ steps.target.outputs.store_url }}
          SHOPIFY_CLI_THEME_TOKEN: ${{ steps.target.outputs.theme_token }}
        run: |
          shopify theme pull --live --force

      - name: Check for Conflicts
        if: steps.merge-base.outputs.merge_success == 'true'
        id: conflict-check
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "No theme changes to sync"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          else
            echo "Theme changes detected, committing..."
            git commit -m "Sync: Latest theme changes from ${{ steps.target.outputs.store_url }}"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          fi

      - name: Update PR Status
        uses: actions/github-script@v7
        with:
          script: |
            const mergeSuccess = '${{ steps.merge-base.outputs.merge_success }}' === 'true';
            const hasConflicts = '${{ steps.merge-base.outputs.has_conflicts }}' === 'true' || 
                                '${{ steps.conflict-check.outputs.has_conflicts }}' === 'true';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: hasConflicts ? 'failure' : 'success',
              description: hasConflicts 
                ? mergeSuccess ? 'Theme sync conflicts detected' : 'Git merge conflicts with base branch'
                : 'Theme sync check passed',
              context: 'theme-sync-check'
            });

            if (!mergeSuccess) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '❌ **Git Merge Conflicts Detected**\n\n' +
                      'This PR has conflicts with the `${{ github.base_ref }}` branch. ' +
                      'Please resolve the merge conflicts before proceeding.\n\n' +
                      '```bash\n' +
                      'git fetch origin ${{ github.base_ref }}\n' +
                      'git merge origin/${{ github.base_ref }}\n' +
                      '# Resolve conflicts manually\n' +
                      'git add .\n' +
                      'git commit -m "Resolve merge conflicts"\n' +
                      'git push\n' +
                      '```'
              });
            } else if (hasConflicts) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '❌ **Theme Sync Conflicts Detected**\n\n' +
                      'This PR has conflicts with the latest theme changes. ' +
                      'Please sync your branch with the latest theme updates.\n\n' +
                      '```bash\n' +
                      'shopify theme pull --live\n' +
                      'git add -A\n' +
                      'git commit -m "Sync: Latest theme changes"\n' +
                      'git push\n' +
                      '```'
              });
            }
